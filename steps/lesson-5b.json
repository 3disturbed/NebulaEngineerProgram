{
    "id": "lesson-5b",
    "title": "Lesson 5b: Creating market-service.js",
    "steps": [
        {
            "title": "The Complete Implementation",
            "content": "<p>Here's the complete <code>market-service.js</code> file that runs the entire microservice:</p><div class=\"code-block\"><code class=\"language-javascript\">// ============================================\n// Market Microservice\n// ============================================\n\n// Our database wrapper\nclass Database {\n    constructor(filename) {\n        this.filename = filename;\n        this.data = {};\n    }\n    \n    write(key, value) {\n        this.data[key] = value;\n        // In real service: write to actual file\n    }\n    \n    read(key) {\n        return this.data[key];\n    }\n}\n\n// Market analyzer\nclass MarketAnalyzer {\n    analyzePrices(items) {\n        this.items = items;\n    }\n    \n    getDemandRatio(itemName) {\n        const item = this.items.find(i => i.name === itemName);\n        if (!item) return 0.5;\n        return item.demand / (item.supply + item.demand);\n    }\n}\n\n// Price calculator\nclass PriceCalculator {\n    constructor() {\n        this.maxChangePercent = 0.10;\n    }\n    \n    calculatePrice(currentPrice, demandRatio) {\n        const pressure = (demandRatio - 0.5) * 2;\n        const adjustment = currentPrice * pressure * this.maxChangePercent;\n        return currentPrice + adjustment;\n    }\n    \n    adjustPrices(items, analyzer) {\n        items.forEach(item => {\n            const demand = analyzer.getDemandRatio(item.name);\n            item.price = this.calculatePrice(item.price, demand);\n        });\n    }\n}\n\n// Initialize services\nconst database = new Database('./market.db');\nconst analyzer = new MarketAnalyzer();\nconst calculator = new PriceCalculator();\n\n// Market items\nconst items = [\n    { name: 'Iron Ore', price: 100, supply: 50, demand: 80 },\n    { name: 'Copper Ore', price: 75, supply: 60, demand: 60 },\n    { name: 'Uranium Ore', price: 500, supply: 20, demand: 2 }\n];\n\n// Market update interval\nconst UPDATE_INTERVAL = 5000; // 5 seconds\n\n// Start the market service\nfunction startMarketService() {\n    console.log('üöÄ Market Service Started');\n    console.log('Updating prices every 5 seconds...');\n    console.log('');\n    \n    setInterval(() => {\n        try {\n            // Analyze current market\n            analyzer.analyzePrices(items);\n            \n            // Adjust all prices\n            calculator.adjustPrices(items, analyzer);\n            \n            // Save to database\n            const timestamp = new Date().toISOString();\n            const marketState = {\n                timestamp: timestamp,\n                items: items.map(item => ({\n                    name: item.name,\n                    price: parseFloat(item.price.toFixed(2)),\n                    demand: analyzer.getDemandRatio(item.name)\n                }))\n            };\n            \n            database.write('market-' + timestamp, marketState);\n            \n            // Display results\n            console.log(`[${timestamp}]`);\n            items.forEach(item => {\n                const ratio = analyzer.getDemandRatio(item.name);\n                const percent = (ratio * 100).toFixed(0);\n                console.log(`  ${item.name}: $${item.price.toFixed(2)} (${percent}% demand)`);\n            });\n            console.log('');\n            \n        } catch (error) {\n            console.error('‚ùå Service error:', error.message);\n        }\n    }, UPDATE_INTERVAL);\n}\n\n// Start the service!\nstartMarketService();</code></div>"
        },
        {
            "title": "What Each Section Does",
            "content": "<p><strong>Classes:</strong> Database, MarketAnalyzer, PriceCalculator</p><ul style=\"margin: 10px 0 10px 20px;\"><li>Everything we've learned in one file</li><li>Each class does one job</li></ul><p style=\"margin-top: 15px;\"><strong>Services:</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li><code>database</code> - Stores market history</li><li><code>analyzer</code> - Calculates demand ratios</li><li><code>calculator</code> - Adjusts prices</li></ul><p style=\"margin-top: 15px;\"><strong>Data:</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li><code>items</code> - The items being tracked</li><li><code>UPDATE_INTERVAL</code> - How often to run</li></ul><p style=\"margin-top: 15px;\"><strong>Main Loop:</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li><code>startMarketService()</code> - Runs forever, updating every 5 seconds</li></ul>"
        },
        {
            "title": "Running the Service",
            "content": "<p>To run the market service in Node.js:</p><div class=\"code-block\"><code class=\"language-bash\">node market-service.js</code></div><p style=\"margin-top: 15px;\"><strong>Expected output:</strong></p><div class=\"code-block\"><code class=\"language-text\">üöÄ Market Service Started\nUpdating prices every 5 seconds...\n\n[2024-01-15T10:30:00.000Z]\n  Iron Ore: $106.00 (62% demand)\n  Copper Ore: $75.00 (50% demand)\n  Uranium Ore: $460.00 (9% demand)\n\n[2024-01-15T10:30:05.000Z]\n  Iron Ore: $112.36 (65% demand)\n  Copper Ore: $75.00 (50% demand)\n  Uranium Ore: $434.00 (8% demand)\n\n[2024-01-15T10:30:10.000Z]\n  Iron Ore: $119.00 (68% demand)\n  Copper Ore: $75.00 (50% demand)\n  Uranium Ore: $410.30 (7% demand)\n...</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString\" target=\"_blank\">MDN: Date.toISOString()</a> - Format timestamp</div>"
        },
        {
            "title": "üéâ Congratulations! You're Done!",
            "content": "<p style=\"font-size: 1.2em; font-weight: bold;\">You've built a complete Node.js microservice!</p><div style=\"margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;\"><h3 style=\"margin: 0 0 10px 0;\">‚ú® What You Learned:</h3><ul style=\"margin: 10px 0 10px 20px; color: white;\"><li>Database safe-write patterns</li><li>Supply & demand economics</li><li>Market analysis algorithms</li><li>Dynamic price calculation</li><li>Microservice architecture</li><li>Error handling & reliability</li></ul></div><p style=\"margin-top: 20px;\"><strong>Next Steps:</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li>Add more items to track</li><li>Store data in a real database (SQLite, PostgreSQL)</li><li>Add API endpoints for external access</li><li>Create a web dashboard</li><li>Deploy to a server (AWS, Heroku, etc)</li></ul><div style=\"margin-top: 25px; padding: 15px; background: #2a2e47; border-left: 4px solid #f9e2af; border-radius: 8px;\"><p style=\"margin: 0;\"><strong>Keep learning!</strong> Markets are complex - research real financial data and pricing models to improve your microservice.</p></div>"
        }
    ]
}
