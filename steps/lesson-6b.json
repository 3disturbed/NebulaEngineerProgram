{
    "id": "lesson-6b",
    "title": "Lesson 6b: Advanced API Endpoints",
    "steps": [
        {
            "title": "Query Parameters for Filtering",
            "content": "<p>URLs can include query parameters like <code>?limit=5&sort=price</code> to filter or sort data:</p><div class=\"code-block\"><code class=\"language-javascript\">// GET /api/market/prices?limit=2&sort=demand\n// Returns only 2 most-demanded items\napp.get('/api/market/list', (req, res) => {\n    analyzer.analyzePrices(items);\n    \n    // Get query parameters\n    const limit = req.query.limit ? parseInt(req.query.limit) : items.length;\n    const sortBy = req.query.sort || 'name'; // name, price, or demand\n    \n    // Sort items\n    let sorted = [...items];\n    if (sortBy === 'price') {\n        sorted.sort((a, b) => b.price - a.price);\n    } else if (sortBy === 'demand') {\n        const ratios = {};\n        items.forEach(item => {\n            ratios[item.name] = analyzer.getDemandRatio(item.name);\n        });\n        sorted.sort((a, b) => ratios[b.name] - ratios[a.name]);\n    }\n    \n    // Limit results\n    const limited = sorted.slice(0, limit);\n    \n    res.json({\n        count: limited.length,\n        items: limited.map(item => ({\n            name: item.name,\n            price: parseFloat(item.price.toFixed(2)),\n            demand: analyzer.getDemandRatio(item.name)\n        }))\n    });\n});</code></div><div class=\"hint\"><strong>Try these URLs:</strong><br><code>/api/market/list?limit=2&sort=price</code><br><code>/api/market/list?sort=demand</code><br><code>/api/market/list</code> (gets all)</div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams\" target=\"_blank\">MDN: URLSearchParams</a> - Parse query strings</div>"
        },
        {
            "title": "Market History Endpoint",
            "content": "<p>Store and retrieve historical price data:</p><div class=\"code-block\"><code class=\"language-javascript\">// Store price history in memory\nconst priceHistory = [];\n\n// Update history every market tick\nfunction recordHistory() {\n    const snapshot = {\n        timestamp: new Date().toISOString(),\n        items: items.map(item => ({\n            name: item.name,\n            price: parseFloat(item.price.toFixed(2))\n        }))\n    };\n    priceHistory.push(snapshot);\n    \n    // Keep only last 100 records\n    if (priceHistory.length > 100) {\n        priceHistory.shift();\n    }\n}\n\n// GET /api/market/history?itemName=Iron%20Ore\napp.get('/api/market/history', (req, res) => {\n    const itemName = req.query.itemName;\n    \n    if (!itemName) {\n        return res.json({\n            totalRecords: priceHistory.length,\n            history: priceHistory\n        });\n    }\n    \n    // Filter history for specific item\n    const itemHistory = priceHistory.map(snapshot => ({\n        timestamp: snapshot.timestamp,\n        item: snapshot.items.find(i => i.name === itemName)\n    })).filter(h => h.item);\n    \n    res.json({\n        itemName: itemName,\n        records: itemHistory.length,\n        history: itemHistory\n    });\n});</code></div><div class=\"hint\"><strong>Example:</strong><br><code>/api/market/history?itemName=Iron%20Ore</code><br>Returns price history for Iron Ore</div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter\" target=\"_blank\">MDN: Array.filter()</a> - Select matching items</div>"
        },
        {
            "title": "Market Statistics Endpoint",
            "content": "<p>Calculate and return market statistics:</p><div class=\"code-block\"><code class=\"language-javascript\">// GET /api/market/stats\napp.get('/api/market/stats', (req, res) => {\n    analyzer.analyzePrices(items);\n    \n    // Calculate statistics\n    const stats = {};\n    \n    items.forEach(item => {\n        const prices = priceHistory\n            .map(h => h.items.find(i => i.name === item.name)?.price)\n            .filter(p => p !== undefined);\n        \n        if (prices.length === 0) return;\n        \n        const minPrice = Math.min(...prices);\n        const maxPrice = Math.max(...prices);\n        const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;\n        const currentPrice = item.price;\n        const change = ((currentPrice - avgPrice) / avgPrice * 100).toFixed(2);\n        \n        stats[item.name] = {\n            current: parseFloat(currentPrice.toFixed(2)),\n            average: parseFloat(avgPrice.toFixed(2)),\n            min: parseFloat(minPrice.toFixed(2)),\n            max: parseFloat(maxPrice.toFixed(2)),\n            changePercent: parseFloat(change)\n        };\n    });\n    \n    res.json({\n        timestamp: new Date().toISOString(),\n        marketStats: stats\n    });\n});</code></div><div class=\"hint\"><strong>Returns:</strong><br>For each item: min price, max price, average, and % change from average</div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/min\" target=\"_blank\">MDN: Math.min()</a> - Find minimum value</div>"
        },
        {
            "title": "Error Handling Best Practices",
            "content": "<p>Handle errors gracefully and return proper status codes:</p><div class=\"code-block\"><code class=\"language-javascript\">// General error handler\napp.use((err, req, res, next) => {\n    console.error('API Error:', err);\n    \n    res.status(500).json({\n        error: 'Internal server error',\n        message: err.message\n    });\n});\n\n// 404 handler for unknown routes\napp.use((req, res) => {\n    res.status(404).json({\n        error: 'Route not found',\n        requested: req.path,\n        availableEndpoints: [\n            'GET /api/market/prices',\n            'GET /api/market/item/:name',\n            'GET /api/market/list?sort=price&limit=5',\n            'GET /api/market/history?itemName=Iron%20Ore',\n            'GET /api/market/stats'\n        ]\n    });\n});</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/500\" target=\"_blank\">MDN: HTTP 500 Error</a> - Server error responses</div>"
        },
        {
            "title": "Knowledge Check",
            "content": "<p>Verify your understanding of advanced API concepts.</p>",
            "quiz": [
                {
                    "question": "How do you access query parameters like `?limit=5` in Express?",
                    "options": [
                        "req.params.limit",
                        "req.query.limit",
                        "req.body.limit"
                    ],
                    "correct": 1
                },
                {
                    "question": "Why do we limit the history array to the last 100 records?",
                    "options": [
                        "To prevent the server from running out of memory over time",
                        "Because arrays can only hold 100 items",
                        "To make the database faster"
                    ],
                    "correct": 0
                }
            ]
        },
        {
            "title": "Lesson 6b Complete! ðŸŽ‰",
            "content": "<p style=\"font-size: 1.1em;\"><strong>You've built a professional API with multiple endpoints.</strong></p><div style=\"margin: 20px 0;\"><div class=\"achievement\">âœ“ Handle query parameters</div><div class=\"achievement\">âœ“ Sort and filter data</div><div class=\"achievement\">âœ“ Store historical data</div><div class=\"achievement\">âœ“ Calculate statistics</div><div class=\"achievement\">âœ“ Handle errors properly</div></div><p style=\"margin-top: 20px; color: #667eea; font-weight: bold;\">â†’ Next: Lesson 6c - Authentication & Security</p>"
        }
    ]
}
