{
    "id": "lesson-6c",
    "title": "Lesson 6c: API Authentication & Security",
    "steps": [
        {
            "title": "Why Authentication Matters",
            "content": "<p>Without authentication, anyone can access (or abuse) your API. Consider this attack:</p><div class=\"hint\"><strong>Problem:</strong><br>Someone could spam your API with 1,000 requests/second, crashing it<br><br><strong>Solution:</strong><br>Require an API key so you can track who uses the service and rate-limit them</div><p style=\"margin-top: 15px;\"><strong>Common authentication methods:</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li><strong>API Keys</strong> - Simple token, passed in headers</li><li><strong>JWT</strong> - JSON Web Tokens with expiration</li><li><strong>OAuth2</strong> - For user-based services (complex)</li></ul><p style=\"margin-top: 15px;\"><strong>We'll use API Keys:</strong> Simple and effective for microservices</p>"
        },
        {
            "title": "API Key Validation Middleware",
            "content": "<p>Create middleware to check API keys on protected routes:</p><div class=\"code-block\"><code class=\"language-javascript\">// Store valid API keys\nconst validApiKeys = {\n    'key-demo-12345': { name: 'Demo Client', limit: 100 },\n    'key-prod-67890': { name: 'Production', limit: 10000 }\n};\n\n// Middleware to verify API key\nfunction validateApiKey(req, res, next) {\n    const apiKey = req.headers['x-api-key'];\n    \n    if (!apiKey) {\n        return res.status(401).json({\n            error: 'Missing API key',\n            hint: 'Include X-API-Key header in request'\n        });\n    }\n    \n    if (!validApiKeys[apiKey]) {\n        return res.status(403).json({\n            error: 'Invalid API key'\n        });\n    }\n    \n    // Store client info on request\n    req.client = validApiKeys[apiKey];\n    next();\n}\n\n// Apply to protected routes\napp.get('/api/market/prices', validateApiKey, (req, res) => {\n    res.json({\n        client: req.client.name,\n        prices: items\n    });\n});</code></div><div class=\"hint\"><strong>Test with curl:</strong><br><code>curl -H \"X-API-Key: key-demo-12345\" http://localhost:3000/api/market/prices</code><br><br>Without key: Returns 401 Unauthorized</div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401\" target=\"_blank\">MDN: HTTP 401 Unauthorized</a> - Authentication required</div>"
        },
        {
            "title": "Rate Limiting",
            "content": "<p>Prevent abuse by limiting requests per client:</p><div class=\"code-block\"><code class=\"language-javascript\">// Track requests per API key\nconst requestCounts = {};\n\n// Rate limiting middleware\nfunction rateLimit(req, res, next) {\n    const apiKey = req.headers['x-api-key'];\n    const now = Date.now();\n    const windowMs = 60000; // 1 minute\n    \n    if (!requestCounts[apiKey]) {\n        requestCounts[apiKey] = [];\n    }\n    \n    // Remove old requests (outside 1 minute window)\n    requestCounts[apiKey] = requestCounts[apiKey].filter(\n        time => now - time < windowMs\n    );\n    \n    const limit = req.client.limit;\n    const count = requestCounts[apiKey].length;\n    \n    if (count >= limit) {\n        return res.status(429).json({\n            error: 'Rate limit exceeded',\n            limit: limit,\n            current: count,\n            retryAfter: '60 seconds'\n        });\n    }\n    \n    // Record this request\n    requestCounts[apiKey].push(now);\n    \n    // Send rate limit info in response\n    res.set('X-RateLimit-Limit', limit);\n    res.set('X-RateLimit-Remaining', limit - count - 1);\n    \n    next();\n}\n\n// Use both middleware: validate key, then check rate limit\napp.get('/api/market/prices', validateApiKey, rateLimit, (req, res) => {\n    res.json({\n        client: req.client.name,\n        prices: items\n    });\n});</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429\" target=\"_blank\">MDN: HTTP 429 Too Many Requests</a> - Rate limit exceeded</div>"
        },
        {
            "title": "CORS & Security Headers",
            "content": "<p>Control who can access your API and protect against attacks:</p><div class=\"code-block\"><code class=\"language-javascript\">// CORS middleware\nconst cors = require('cors');\n\napp.use(cors({\n    origin: ['https://yourdomain.com', 'https://admin.yourdomain.com'],\n    methods: ['GET', 'POST'],\n    credentials: true\n}));\n\n// Security headers\napp.use((req, res, next) => {\n    // Prevent clickjacking\n    res.setHeader('X-Frame-Options', 'DENY');\n    \n    // Prevent MIME type sniffing\n    res.setHeader('X-Content-Type-Options', 'nosniff');\n    \n    // Enable XSS protection\n    res.setHeader('X-XSS-Protection', '1; mode=block');\n    \n    // Strict transport security\n    res.setHeader('Strict-Transport-Security', 'max-age=31536000');\n    \n    next();\n});\n\n// Log all requests\napp.use((req, res, next) => {\n    console.log(`[${new Date().toISOString()}] ${req.method} ${req.path} (${req.client?.name || 'unknown'})`);\n    next();\n});</code></div><div class=\"hint\"><strong>Install cors:</strong><br><code>npm install cors</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\" target=\"_blank\">MDN: CORS</a> - Cross-Origin Resource Sharing</div>"
        },
        {
            "title": "Complete Secure API Server",
            "content": "<p>Put it all together in a production-ready API:</p><div class=\"code-block\"><code class=\"language-javascript\">const express = require('express');\nconst cors = require('cors');\nconst app = express();\n\napp.use(express.json());\napp.use(cors());\n\n// Security headers\napp.use((req, res, next) => {\n    res.setHeader('X-Frame-Options', 'DENY');\n    res.setHeader('X-Content-Type-Options', 'nosniff');\n    next();\n});\n\nconst validApiKeys = {\n    'key-demo-12345': { name: 'Demo', limit: 100 }\n};\nconst requestCounts = {};\n\nfunction validateApiKey(req, res, next) {\n    const apiKey = req.headers['x-api-key'];\n    if (!apiKey || !validApiKeys[apiKey]) {\n        return res.status(401).json({ error: 'Invalid API key' });\n    }\n    req.client = validApiKeys[apiKey];\n    next();\n}\n\nfunction rateLimit(req, res, next) {\n    const apiKey = req.headers['x-api-key'];\n    const now = Date.now();\n    \n    if (!requestCounts[apiKey]) requestCounts[apiKey] = [];\n    requestCounts[apiKey] = requestCounts[apiKey]\n        .filter(time => now - time < 60000);\n    \n    if (requestCounts[apiKey].length >= req.client.limit) {\n        return res.status(429).json({ error: 'Rate limit exceeded' });\n    }\n    \n    requestCounts[apiKey].push(now);\n    res.set('X-RateLimit-Remaining', req.client.limit - requestCounts[apiKey].length);\n    next();\n}\n\napp.get('/api/market/prices', validateApiKey, rateLimit, (req, res) => {\n    res.json({ client: req.client.name, prices: items });\n});\n\napp.listen(3000, () => {\n    console.log('ðŸ”’ Secure API running on port 3000');\n});</code></div>"
        },
        {
            "title": "Knowledge Check",
            "content": "<p>Verify your understanding of API security.</p>",
            "quiz": [
                {
                    "question": "What is the purpose of rate limiting?",
                    "options": [
                        "To make the API slower for everyone",
                        "To prevent abuse by limiting the number of requests a client can make in a given time",
                        "To charge users more money"
                    ],
                    "correct": 1
                },
                {
                    "question": "Which HTTP header is commonly used to send an API key?",
                    "options": [
                        "X-API-Key",
                        "Content-Type",
                        "User-Agent"
                    ],
                    "correct": 0
                }
            ]
        },
        {
            "title": "Lesson 6c Complete! ðŸŽ‰",
            "content": "<p style=\"font-size: 1.1em;\"><strong>You've built a secure, production-ready API.</strong></p><div style=\"margin: 20px 0;\"><div class=\"achievement\">âœ“ Implement API key authentication</div><div class=\"achievement\">âœ“ Add rate limiting to prevent abuse</div><div class=\"achievement\">âœ“ Configure CORS for cross-origin requests</div><div class=\"achievement\">âœ“ Set security headers</div><div class=\"achievement\">âœ“ Log requests for monitoring</div></div><p style=\"margin-top: 20px; color: #667eea; font-weight: bold;\">â†’ Next: Lesson 6d - WebSockets & Real-Time Updates</p>"
        }
    ]
}
