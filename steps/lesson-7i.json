{
    "id": "lesson-7i",
    "title": "Lesson 7i: The Game Loop",
    "steps": [
        {
            "title": "Understanding Game Loops",
            "content": "<p>A game loop is the heartbeat of your application.</p><div class=\"info-box\"><strong>How it works:</strong><br>1. <strong>Input:</strong> Handle user actions<br>2. <strong>Update:</strong> Advance game state (physics, AI, time)<br>3. <strong>Render:</strong> Draw the new state to the screen<br>4. <strong>Repeat:</strong> Do it all again (60 times per second)</div><p style=\"margin-top: 15px;\"><strong>Why not just use setInterval?</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li><code>requestAnimationFrame</code> syncs with screen refresh rate</li><li>Pauses when tab is inactive (saves battery)</li><li>Smoother animations</li></ul>"
        },
        {
            "title": "Time Management",
            "content": "<p><strong>Add time progression to GameState:</strong></p><div class=\"code-block\"><code class=\"language-javascript\">    // Add to GameState class\n    tick(hours = 1) {\n        this.clock.totalHours += hours;\n        \n        // Update market prices (simple oscillation)\n        Object.keys(this.market.prices).forEach(commodity => {\n            const basePrice = 100;\n            const hour = this.clock.totalHours % 24;\n            const variance = Math.sin(hour / 12 * Math.PI) * 20;\n            this.market.prices[commodity] = Math.max(50, basePrice + variance);\n        });\n        \n        // Update navigation if traveling\n        if (this.navigation.traveling && this.navigation.target) {\n            this.updateNavigationProgress(hours);\n        }\n        \n        this.notifyListeners();\n    }\n    \n    updateNavigationProgress(hours) {\n        const dx = this.navigation.target.x - this.navigation.position.x;\n        const dy = this.navigation.target.y - this.navigation.position.y;\n        const distance = Math.sqrt(dx * dx + dy * dy);\n        const speed = 2;  // sectors per hour\n        \n        if (distance > 0.1) {\n            const travel = Math.min(speed * hours, distance);\n            const ratio = travel / distance;\n            \n            this.navigation.position.x += dx * ratio;\n            this.navigation.position.y += dy * ratio;\n            this.navigation.eta = Math.max(0, this.navigation.eta - hours);\n        } else {\n            this.navigation.position = this.navigation.target;\n            this.navigation.target = null;\n            this.navigation.traveling = false;\n            this.addEvent('Arrived at destination');\n        }\n    }</code></div>"
        },
        {
            "title": "The GameEngine Class",
            "content": "<p><strong>Create the engine that drives the loop:</strong></p><div class=\"code-block\"><code class=\"language-javascript\">class GameEngine {\n    constructor(gameState) {\n        this.state = gameState;\n        this.isRunning = false;\n        this.speed = 1;  // 1x speed\n        this.lastFrameTime = Date.now();\n    }\n    \n    start() {\n        if (this.isRunning) return;\n        this.isRunning = true;\n        this.lastFrameTime = Date.now();\n        this.animate();\n    }\n    \n    stop() {\n        this.isRunning = false;\n    }\n    \n    setSpeed(factor) {\n        this.speed = factor;\n    }\n    \n    animate() {\n        if (!this.isRunning) return;\n        \n        const now = Date.now();\n        // Calculate time since last frame in seconds\n        const deltaTime = (now - this.lastFrameTime) / 1000;\n        this.lastFrameTime = now;\n        \n        // Update game state\n        // 1 real second = 10 game hours (at 1x speed)\n        const gameHours = deltaTime * 10 * this.speed;\n        this.state.tick(gameHours);\n        \n        // Request next frame\n        requestAnimationFrame(() => this.animate());\n    }\n}</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame\" target=\"_blank\">MDN: requestAnimationFrame()</a> - Smooth animation</div>"
        },
        {
            "title": "Controlling Game Speed",
            "content": "<p><strong>Allow players to control time:</strong></p><div class=\"code-block\"><code class=\"language-javascript\">// Initialize\nconst gameState = new GameState();\nconst engine = new GameEngine(gameState);\n\n// Start the game\nengine.start();\n\n// Speed controls\ndocument.getElementById('pauseBtn').addEventListener('click', () => {\n    engine.stop();\n});\n\ndocument.getElementById('playBtn').addEventListener('click', () => {\n    engine.start();\n});\n\ndocument.getElementById('speedSlider').addEventListener('input', (e) => {\n    const speed = parseFloat(e.target.value);\n    engine.setSpeed(speed);\n    console.log(`Game speed: ${speed}x`);\n});</code></div>"
        },
        {
            "title": "Knowledge Check",
            "content": "<p>Verify your understanding of the game loop.</p>",
            "quiz": [
                {
                    "question": "What is `deltaTime` in the context of a game loop?",
                    "options": [
                        "The time difference between the current frame and the previous frame",
                        "The total time the game has been running",
                        "The time it takes to render one pixel"
                    ],
                    "correct": 0
                },
                {
                    "question": "Why do we multiply `deltaTime` by a speed factor when updating the game state?",
                    "options": [
                        "To make the game run faster on slower computers",
                        "To decouple the game logic update rate from the frame rate, ensuring consistent gameplay speed regardless of FPS",
                        "To increase the difficulty of the game"
                    ],
                    "correct": 1
                }
            ]
        },
        {
            "title": "Lesson 7i Complete! ðŸŽ‰",
            "content": "<p style=\"font-size: 1.1em;\"><strong>You've brought your game to life with time.</strong></p><div style=\"margin: 20px 0;\"><div class=\"achievement\">âœ“ Implement game loop pattern</div><div class=\"achievement\">âœ“ Calculate delta time</div><div class=\"achievement\">âœ“ Manage game time vs real time</div><div class=\"achievement\">âœ“ Add speed controls</div></div><p style=\"margin-top: 20px; color: #667eea; font-weight: bold;\">â†’ Next: Lesson 7j - Complete Game Interface</p>"
        }
    ]
}
