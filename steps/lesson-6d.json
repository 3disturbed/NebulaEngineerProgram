{
    "id": "lesson-6d",
    "title": "Lesson 6d: Real-Time Updates with WebSockets",
    "steps": [
        {
            "title": "HTTP vs WebSockets",
            "content": "<p>REST APIs use <strong>HTTP</strong> - client asks for data, server responds. But what if data changes constantly?</p><div class=\"hint\"><strong>Problem with REST:</strong><br>Client must ask every second: \"Is the price updated?\"<br>Wasteful! Most requests get \"No change\"<br><br><strong>Solution - WebSockets:</strong><br>Server pushes updates to all clients instantly<br>Bidirectional, always-open connection</div><p style=\"margin-top: 15px;\"><strong>When to use each:</strong></p><ul style=\"margin: 10px 0 10px 20px;\"><li><strong>REST:</strong> Static data, occasional reads (weather, user profiles)</li><li><strong>WebSocket:</strong> Live data, constant updates (markets, chat, games)</li></ul><p style=\"margin-top: 15px;\"><strong>Our market updates every 5 seconds - perfect for WebSockets!</strong></p>"
        },
        {
            "title": "Setting Up Socket.IO",
            "content": "<p>Socket.IO is the easiest WebSocket library. Install it:</p><div class=\"code-block\"><code class=\"language-bash\">npm install socket.io</code></div><p style=\"margin-top: 15px;\"><strong>Create a WebSocket server:</strong></p><div class=\"code-block\"><code class=\"language-javascript\">const express = require('express');\nconst http = require('http');\nconst socketIO = require('socket.io');\n\nconst app = express();\nconst server = http.createServer(app);\nconst io = socketIO(server, {\n    cors: {\n        origin: '*',\n        methods: ['GET', 'POST']\n    }\n});\n\n// Track connected clients\nlet connectedClients = 0;\n\n// When client connects\nio.on('connection', (socket) => {\n    connectedClients++;\n    console.log(`Client connected. Total: ${connectedClients}`);\n    \n    // When client disconnects\n    socket.on('disconnect', () => {\n        connectedClients--;\n        console.log(`Client disconnected. Total: ${connectedClients}`);\n    });\n});\n\nserver.listen(3000, () => {\n    console.log('ðŸ”Œ WebSocket server running on port 3000');\n});</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\" target=\"_blank\">MDN: WebSocket API</a> - Real-time communication</div>"
        },
        {
            "title": "Broadcasting Price Updates",
            "content": "<p>Send market updates to all connected clients every 5 seconds:</p><div class=\"code-block\"><code class=\"language-javascript\">// Update interval\nconst UPDATE_INTERVAL = 5000; // 5 seconds\n\n// Market update loop\nsetInterval(() => {\n    // Update market prices\n    analyzer.analyzePrices(items);\n    calculator.adjustPrices(items, analyzer);\n    \n    // Create update payload\n    const update = {\n        timestamp: new Date().toISOString(),\n        items: items.map(item => ({\n            name: item.name,\n            price: parseFloat(item.price.toFixed(2)),\n            demandRatio: analyzer.getDemandRatio(item.name)\n        }))\n    };\n    \n    // Send to ALL connected clients\n    io.emit('market:update', update);\n    \n    // Also log it\n    console.log(`[${update.timestamp}] Sent update to ${connectedClients} clients`);\n    \n}, UPDATE_INTERVAL);</code></div><div class=\"hint\"><strong>Key points:</strong><br>â€¢ <code>io.emit()</code> sends to all clients<br>â€¢ Called every 5 seconds<br>â€¢ Clients receive updates in real-time</div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener\" target=\"_blank\">MDN: addEventListener</a> - Listen for events</div>"
        },
        {
            "title": "Client-Side WebSocket",
            "content": "<p>Connect to the WebSocket and receive updates from the browser:</p><div class=\"code-block\"><code class=\"language-javascript\">// Connect to WebSocket server\nconst socket = io('http://localhost:3000');\n\n// Listen for connection\nsocket.on('connect', () => {\n    console.log('âœ“ Connected to market server');\n    document.getElementById('status').textContent = 'Connected';\n});\n\n// Listen for market updates\nsocket.on('market:update', (data) => {\n    console.log('ðŸ“Š Market update received:');\n    console.log(data);\n    \n    // Update UI with new prices\n    const priceList = document.getElementById('prices');\n    priceList.innerHTML = '';\n    \n    data.items.forEach(item => {\n        const div = document.createElement('div');\n        div.innerHTML = `\n            <strong>${item.name}</strong><br>\n            Price: $${item.price}<br>\n            Demand: ${(item.demandRatio * 100).toFixed(0)}%\n        `;\n        priceList.appendChild(div);\n    });\n});\n\n// Listen for disconnect\nsocket.on('disconnect', () => {\n    console.log('âœ— Disconnected from server');\n    document.getElementById('status').textContent = 'Disconnected';\n});</code></div><div class=\"hint\"><strong>Add to HTML:</strong><br><code>&lt;script src=\"https://cdn.socket.io/4.5.4/socket.io.min.js\"&gt;&lt;/script&gt;</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/close\" target=\"_blank\">MDN: WebSocket close event</a> - Handle disconnection</div>"
        },
        {
            "title": "Request-Response with WebSockets",
            "content": "<p>WebSockets aren't just for broadcasting - clients can request specific data:</p><div class=\"code-block\"><code class=\"language-javascript\">// Server: Listen for client requests\nio.on('connection', (socket) => {\n    // Client asks for history\n    socket.on('request:history', (data) => {\n        const itemName = data.itemName;\n        \n        // Send only relevant history\n        const history = priceHistory.filter(h => \n            h.items.some(i => i.name === itemName)\n        );\n        \n        // Send back to that specific client\n        socket.emit('response:history', {\n            itemName: itemName,\n            history: history.slice(-20) // Last 20 records\n        });\n    });\n});\n\n// Client: Request specific data\nsocket.emit('request:history', { itemName: 'Iron Ore' });\n\n// Client: Receive the response\nsocket.on('response:history', (data) => {\n    console.log(`Price history for ${data.itemName}:`);\n    data.history.forEach(record => {\n        console.log(`${record.timestamp}: $${record.price}`);\n    });\n});</code></div><div class=\"read-more\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/EventEmitter\" target=\"_blank\">MDN: Event-driven architecture</a> - Request-response pattern</div>"
        },
        {
            "title": "Knowledge Check",
            "content": "<p>Verify your understanding of WebSockets.</p>",
            "quiz": [
                {
                    "question": "What is the main advantage of WebSockets over REST for a real-time game?",
                    "options": [
                        "WebSockets are easier to code",
                        "WebSockets allow the server to push updates to the client instantly without the client asking",
                        "WebSockets use less internet data"
                    ],
                    "correct": 1
                },
                {
                    "question": "Which method sends a message to ALL connected clients?",
                    "options": [
                        "socket.emit()",
                        "io.emit()",
                        "server.send()"
                    ],
                    "correct": 1
                }
            ]
        },
        {
            "title": "Lesson 6d Complete! ðŸŽ‰",
            "content": "<p style=\"font-size: 1.1em;\"><strong>You've built a real-time market system.</strong></p><div style=\"margin: 20px 0;\"><div class=\"achievement\">âœ“ Understand WebSocket advantages</div><div class=\"achievement\">âœ“ Set up Socket.IO server</div><div class=\"achievement\">âœ“ Broadcast updates to all clients</div><div class=\"achievement\">âœ“ Connect clients and receive live data</div><div class=\"achievement\">âœ“ Handle client requests via WebSocket</div></div><p style=\"margin-top: 20px; color: #667eea; font-weight: bold;\">â†’ Next: Lesson 6e - Deployment & Production</p>"
        }
    ]
}
